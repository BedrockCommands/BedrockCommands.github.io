<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title | default: site.title }}</title>
    <meta name="description" content="{{ page.description | default: site.description }}">
    <meta property="og:title" content="{{ page.title | default: site.title }}">
    <meta property="og:description" content="{{ page.description | default: site.description }}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ page.url | absolute_url }}">
    <meta property="og:image" content="{{ page.image | default: '/assets/images/og-default.png' | absolute_url }}">
    <meta name="theme-color" content="{{ page.color | default: '#3498db' }}">
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
    <link rel="icon" type="image/png" href="{{ '/favicon.png' | relative_url }}">
</head>
<body data-path="{{ page.url }}">

    <div id="content-overlay"></div>

    {% include header.html %}

      <main>
        <aside id="toc-container">
        <h2 id="toc-title">Contents</h2>
        <button id="toc-toggle" aria-expanded="false">
          Contents
          <span class="toc-arrow">▾</span>
        </button>
        <ul id="toc-list"></ul>
      </aside>
          {{ content }}
      </main>

    {% include footer.html %}

    <script>
      if (/Mobi|Android/i.test(navigator.userAgent)) {
        document.body.classList.add('mobile');
      }

      function copyCommand(button) {
        const code = button.parentElement.querySelector("code");
        const text = code.innerText;

        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text).then(() => {
            button.textContent = "Copied!";
            setTimeout(() => button.textContent = "Copy", 1500);
          }).catch(() => fallbackCopy(code, button));
        } else {
          fallbackCopy(code, button);
        }
      }

      function fallbackCopy(codeElement, button) {
        const range = document.createRange();
        range.selectNodeContents(codeElement);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        try {
          document.execCommand('copy');
          button.textContent = "Copied!";
          setTimeout(() => button.textContent = "Copy", 1500);
        } catch (err) {
          button.textContent = "Failed";
          console.error('Fallback copy failed:', err);
        }

        selection.removeAllRanges();
      }

      function toggleMenu() {
        const menu = document.getElementById("nav-menu");
        const menuIcon = document.getElementById("menu-icon");
        const overlay = document.getElementById("content-overlay");
        const isOpen = menu.classList.contains("active");
    
        if (isOpen) {
          menu.classList.remove("active");
          document.body.classList.remove("menu-open");
          menuIcon.textContent = "☰"; // Hamburger icon
          if (window.innerWidth <= 768) {
            overlay.style.display = "none"; // Hide overlay
          }
        } else {
          menu.classList.add("active");
          document.body.classList.add("menu-open");
          menuIcon.textContent = "✖"; // Close icon
          if (window.innerWidth <= 768) {
            overlay.style.display = "block"; // Show overlay
          }
        }
      }

      // Ensure correct sidebar state on page load
      document.addEventListener("DOMContentLoaded", function() {
        const menu = document.getElementById("nav-menu");
        const menuIcon = document.getElementById("menu-icon");
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('#nav-menu li a');

        navLinks.forEach(link => {
          if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
          }
        });

        const isTasksPage = currentPath.includes("/projects/cook-off/tasks/");

        if (!isTasksPage && window.innerWidth > 768) {
          menu.classList.add("active");
          document.body.classList.add("menu-open");
          menuIcon.textContent = "✖"; // Close icon
        } else {
          menu.classList.remove("active");
          document.body.classList.remove("menu-open");
          menuIcon.textContent = "☰"; // Hamburger icon
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        let activeDropdown = null; // Track the currently open dropdown

        function setupDropdown(dropdownId) {
          const dropdown = document.getElementById(dropdownId);
          if (!dropdown) return;

          const button = dropdown.querySelector(".dropdown-btn");
          const menu = dropdown.querySelector(".dropdown-menu");
          const checkboxes = menu.querySelectorAll("input[type='checkbox']");
          const allOption = menu.querySelector("input[type='checkbox'][value='']");

          if (allOption) {
            allOption.checked = true;
            checkboxes.forEach(checkbox => {
              checkbox.checked = true;
            });
          }

          if (allOption) {
            allOption.addEventListener("change", function () {
              checkboxes.forEach(checkbox => {
                checkbox.checked = allOption.checked;
              });
              filterBanners();
            });
          }

          checkboxes.forEach(checkbox => {
            checkbox.addEventListener("change", function () {
              if (!checkbox.checked && allOption) {
                allOption.checked = false;
              } else if (allOption) {
                const allChecked = [...checkboxes].every(cb => cb.checked || cb === allOption);
                allOption.checked = allChecked;
              }
              filterBanners();
            });
          });

          button.addEventListener("click", function (event) {
            event.stopPropagation();
            if (activeDropdown && activeDropdown !== dropdown) {
              activeDropdown.classList.remove("active");
            }
            dropdown.classList.toggle("active");
            activeDropdown = dropdown.classList.contains("active") ? dropdown : null;
          });
        }

        function filterBanners() {
          const selectedYears = getSelectedValues("#year-dropdown");
          const selectedMonths = getSelectedValues("#month-dropdown");
          const selectedAuthors = getSelectedValues("#author-dropdown");
          const selectedJams = getSelectedValues("#jam-dropdown");
          const selectedMaps = getSelectedValues("#map-dropdown");

          document.querySelectorAll(".banner").forEach(banner => {
            const bannerYear = banner.dataset.year;
            const bannerMonth = banner.dataset.month;
            const bannerAuthors = banner.dataset.authors
                ? banner.dataset.authors.split(", ")
                :   banner.dataset.author
                    ? [banner.dataset.author]
                    : [];
            const bannerJam = banner.dataset.jam || "";
            const bannerMap = banner.dataset.map || "";

            const matchesYear = selectedYears.length === 0 || selectedYears.includes(bannerYear);
            const matchesMonth = selectedMonths.length === 0 || selectedMonths.includes(bannerMonth);
            const matchesAuthor = selectedAuthors.length === 0 || selectedAuthors.some(author => bannerAuthors.includes(author));
            const matchesJam = selectedJams.length === 0 || selectedJams.includes(bannerJam);
            const matchesMap = selectedMaps.length === 0 || selectedMaps.includes(bannerMap);

            banner.style.display = matchesYear && matchesMonth && matchesAuthor && matchesJam && matchesMap ? "block" : "none";
          });
        }

        function getSelectedValues(dropdownId) {
          return [...document.querySelectorAll(`${dropdownId} .dropdown-menu input[type='checkbox']:checked`)]
              .map(cb => cb.value)
              .filter(value => value !== "");
        }

        document.addEventListener("click", function (event) {
          if (activeDropdown && !activeDropdown.contains(event.target)) {
            activeDropdown.classList.remove("active");
            activeDropdown = null;
          }
        });

        setupDropdown("year-dropdown");
        setupDropdown("month-dropdown");
        setupDropdown("author-dropdown");
        setupDropdown("jam-dropdown");
        setupDropdown("map-dropdown");
      });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
    const tocContainer = document.getElementById("toc-container");
    const tocList = document.getElementById("toc-list");
    const tocToggle = document.getElementById("toc-toggle");

    if (!tocContainer || !tocList) return;

    // Find headers for TOC
    const headers = [...document.querySelectorAll(
        "main h2:not(#toc-title), main h3, main h4, main h5, main h6"
    )].filter(header => !header.closest("button, .card, .no-toc"));

    if (headers.length > 0) {
        tocContainer.classList.add("visible");
        document.body.classList.add("toc-active");
    } else {
        // Hide TOC completely on pages with no headers
        tocContainer.style.display = "none";
        return; // no need to build TOC
    }

    // Build TOC list
    headers.forEach((header, index) => {
        const text = header.innerText.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|[\uD83C-\uDBFF\uDC00-\uDFFF])/g, '').trim();
        const id = header.id || `toc-header-${index}`;
        header.id = id;

        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = `#${id}`;
        a.textContent = text;
        a.classList.add(`toc-${header.tagName.toLowerCase()}`);
        li.appendChild(a);
        tocList.appendChild(li);
    });

    // Mobile toggle
    if (tocToggle) {
        tocToggle.addEventListener("click", () => {
            const isOpen = tocContainer.classList.toggle("open");
            tocToggle.setAttribute("aria-expanded", isOpen);

            if (isOpen) {
                const listHeight = tocList.scrollHeight;
                const toggleHeight = tocToggle.offsetHeight;
                tocContainer.style.maxHeight = toggleHeight + listHeight + "px";
            } else {
                tocContainer.style.maxHeight = tocToggle.offsetHeight + "px";
            }
        });

        // Recalc on resize
        window.addEventListener("resize", () => {
            if (tocContainer.classList.contains("open")) {
                const listHeight = tocList.scrollHeight;
                const toggleHeight = tocToggle.offsetHeight;
                tocContainer.style.maxHeight = toggleHeight + listHeight + "px";
            }
        });
    }
});
</script>
</body>
</html>
